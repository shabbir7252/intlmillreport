
@{
    ViewBag.Title = "SALES ANALYTICS";
    ViewBag.SubTitle = "";

    var fromDate = ViewBag.fromDate;
    var toDate = ViewBag.toDate;

    var fromD = ViewBag.fromD;
    var toD = ViewBag.toD;
    var jsonResult = ViewBag.jsonResult;
    var jsonResult2 = ViewBag.jsonResult2;
}

<style>
    .e-grid .e-rowcell.customcss {
        font-size: 11px;
    }

    .e-grid .e-headercell.customcss {
        font-size: 11px;
    }

    .e-grid .e-summaryrow .e-summarycell, .e-grid .e-summaryrow .e-templatecell {
        font-size: 11px;
    }

    .e-headertext {
        font-size: 11px;
    }

    .e-grid .e-headercell.custom-header-css {
        background-color: #eee8aa;
    }

    .e-grid .e-headercell.custom-header-qty-css {
        background-color: #d9ff81;
    }

    .e-grid .e-headercell.custom-header-kg-css {
        background-color: #81d8ff;
    }

    .hiddenRow {
        padding: 0 4px !important;
        background-color: #eeeeee;
        font-size: 13px;
    }

    .accordian-body span {
        color: #a2a2a2 !important;
    }

    #box1 {
        width: 400px;
        height: 300px;
        border-style: solid;
        border-width: 2px;
    }

    canvas {
        max-width: 100%;
        max-height: 100%;
    }
</style>

<div id="main-container" class="container-fluid">
    @if (ViewBag.validation == "true")
    {
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger alert-dismissible" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>
                    Start Date is Greater then End Date
                </div>
            </div>
        </div>
    }
    <div class="row clearfix">
        <div class="col-12">
            <div class="card">
                @*@using (Html.BeginForm("BranchSales", "Dashboard", FormMethod.Get))
                    {*@
                <div class="row p-3">
                    <div class="col-3">
                        @Html.EJS().DateTimePicker("fromDate").Format("dd/MMM/yyyy hh:mm a").Value(@fromD).Render()
                    </div>
                    <div class="col-3">
                        @Html.EJS().DateTimePicker("toDate").Format("dd/MMM/yyyy hh:mm a").Value(@toD).Render()
                    </div>

                    <div class="col-2">
                        @*<button type="submit" class="btn btn-raised bg-black waves-effect waves-light">Get Records</button>*@
                        <button class="btn btn-raised bg-black waves-effect waves-light" onclick="GetRecords();">Get Records</button>
                    </div>
                </div>
                @*}*@
            </div>
        </div>
    </div>

    <div id="sales-div">
        <h4 class="text-center">@fromD to @toD</h4>
        <div class="preloader loading">
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
        </div>
        <h5 class="text-center loading-text mt-2">Loading Sales Data. Please Wait (<span id="secondsCounter"></span>)...</h5>
        <div class="branch-sales mb-5"></div>


        <div class="preloader-detail loading">
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
            <span class="slice"></span>
        </div>
        <h5 class="text-center loading-detail-text mt-2">Loading Top 10 Details. Please Wait...</h5>
        <div class="branch-sales-detail mb-5"></div>
    </div>
</div>

<button id="button">btn</button>


@section scripts {
    <script>

        //$(".sec-online-sales").hide();
        //$(".btn-online-sales").click(function () {
        //    $(".sec-online-sales").toggle();
        //});

        //$('.accordion-toggle').click(function () {
        //    $('.hiddenRow').hide();
        //    $(this).next('tr').find('.hiddenRow').show();
        //});

        // branch-sales-detail

        $('.preloader').hide();
        $('.loading-text').hide();

        function GetRecords() {

            $('.preloader').show();
            $('.loading-text').show();
            $('.branch-sales').html("");

            var counter = 0;
            var myInterval = setInterval(function () {
                ++counter;
                $('#secondsCounter').html(counter);
            }, 1000);

            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();

            $.ajax({
                type: 'GET',
                data: { fromDate: fromDate, toDate: toDate},
                url: '@Url.Action("BranchSalesRecord", "Dashboard")',
                success: function (response) {

                    clearInterval(myInterval);
                    $('.preloader').hide();
                    $('.loading-text').hide();
                    $('.branch-sales').html(response);
                    $('#secondsCounter').html("");
                    var data = localStorage.getItem("ColumnChartData");
                    var c = document.getElementById("barChart");
                    var ctx = c.getContext("2d");
                    var myBarChart = new Chart(ctx, {
                        type: 'bar',
                        data: JSON.parse((data.replace(/(&quot\;)/g, "\""))).ChartData,
                        options: {
                            responsive: true,
                            legend: false
                        }
                    });
                },
                error: function (ex) {
                    alert(ex);
                    $('.preloader').hide();
                }

            });
        }

        $('.preloader-detail').hide();
        $('.loading-detail-text').hide();

        function GetRecordsDetail() {

            $('.preloader-detail').show();
            $('.loading-detail-text').show();
            $('.branch-sales-detail').html("");

            var detailCounter = 0;
            var myDetailInterval = setInterval(function () {
                ++detailCounter;
                $('#secondsDetailCounter').html(detailCounter);
            }, 1000);

            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();

            $.ajax({
                type: 'GET',
                data: { fromD: fromDate, toD: toDate},
                url: '@Url.Action("BranchSalesDetailRecord", "Dashboard")',
                success: function (response) {
                    detailCounter = 0;
                    clearInterval(myDetailInterval);
                    $('.preloader-detail').hide();
                    $('.loading-detail-text').hide();
                    $('.branch-sales-detail').html(response);
                    $('#secondsDetailCounter').html("");
                    $("html, body").animate({ scrollTop: $(document).height() }, 1000);
                    $('#button').click();

                },
                error: function (ex) {
                    alert(ex);
                    $('.preloader-detail').hide();
                }
            });
        }

        $(function () {
            GetRecords();
            GetRecordsDetail();

            $("#button").click(function () {

                var svgString = new XMLSerializer().serializeToString(document.querySelector('svg'));

                var canvas = document.getElementById("canvas");
                var ctx = canvas.getContext("2d");
                var DOMURL = self.URL || self.webkitURL || self;
                var img = new Image();
                var svg = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
                var url = DOMURL.createObjectURL(svg);
                img.onload = function () {
                    ctx.drawImage(img, 0, 0);
                    var png = canvas.toDataURL("image/png");
                    document.querySelector('#png-container').innerHTML = '<img src="' + png + '"/>';
                    DOMURL.revokeObjectURL(png);
                };
                img.src = url;

                $('#svg-container').hide();
                $('#canvas').hide();

                setTimeout(function () {
                    domtoimage.toBlob(document.getElementById('sales-div'))
                    .then(function (blob) {
                        // window.saveAs(blob, "output.png");

                        var files = blob;
                        if (files.size > 0) {

                            if (window.FormData !== undefined) {
                                var data = new FormData();
                                data.append("file", files);
                                if ('@ViewBag.ReportType' === '1') {
                                    $.ajax({
                                        type: "POST",
                                        url: '@Url.Action("SaveWeeklyDashboard", "Dashboard")',
                                        contentType: false,
                                        processData: false,
                                        data: data,
                                        success: function (result) {
                                            window.close();
                                        },
                                        error: function (xhr, status, p3, p4) {
                                            var err = "Error " + " " + status + " " + p3 + " " + p4;
                                            if (xhr.responseText && xhr.responseText[0] == "{")
                                                err = JSON.parse(xhr.responseText).Message;
                                            console.log(err);
                                        }
                                    });
                                }
                            } else {
                                alert("This browser doesn't support HTML5 file uploads!");
                            }
                        }
                    });
                }, 5000);

            });
        });

    </script>
}
